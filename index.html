<html>
  <head>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css"
    />
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/jsonata/jsonata.min.js"></script>
  </head>
  <body>
    <main class="container">
      <div x-data="apiResultHiLighter()">
        <div>
          <label for="apiUrl">
            Api Url
            <input x-model="apiUrl" name="apiUrl" type="text" />
          </label>
          <label for="jsonataQuery">
            JSONata Query
            <input x-model="jsonataQuery" name="jsonataQuery" type="text" />
          </label>
          <label for="hightlightTerm">
            Highlight
            <input x-model="hightlightTerm" name="hightlightTerm" type="text" />
          </label>

          <button
            type="button"
            @click="executeApiHilight()"
            :aria-busy="isLoading"
          >
            Search
          </button>
        </div>
        <template x-if="data">
          <div
            id="tree-result"
            style="font-family: monospace; white-space: pre"
            x-html="searchResults"
          ></div>
        </template>
      </div>
    </main>
  </body>
</html>
<script>
  function apiResultHiLighter() {
    return {
      data: null,
      apiUrl: "https://api.warframestat.us/pc",
      jsonataQuery: "syndicateMissions.jobs",
      hightlightTerm: "",
      searchResults: "N/A",
      isLoading: false,
      executeApiHilight() {
        this.isLoading = true;
        this.searchResults = "Loading...";
        fetch(this.apiUrl)
          .then((response) => {
            if (!response.ok)
              alert(
                `Something went wrong: ${response.status} - ${response.statusText}`
              );
            this.isLoading = false;
            return response.json();
          })
          .then((data) => {
            this.data = data;
            let result = jsonata(this.jsonataQuery).evaluate(this.data);

            this.searchResults = syntaxHighlight(
              JSON.stringify(result, null, "\t"),
              this.hightlightTerm === "" ? "zzzz" : this.hightlightTerm
            );

            this.isLoading = false;
          });
      },
      searchData() {
        // .replaceAll(
        //   new RegExp(this.hightlightTerm, "gi"),
        //   "<span style='color:purple'>" + this.hightlightTerm + "</span>"
        // ));
      },
    };
  }

  function syntaxHighlight(json, hilite) {
    json = json
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
    return json.replace(
      /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
      function (match) {
        var cls = "number";
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = "key";
          } else {
            cls = "string";
          }
        } else if (/true|false/.test(match)) {
          cls = "boolean";
        } else if (/null/.test(match)) {
          cls = "null";
        }
        let ret = '<span class="' + cls + '">' + match + "</span>";
        ret = ret.replaceAll(
          new RegExp(hilite, "gi"),
          "<mark>" + hilite + "</mark>"
        );
        return ret;
      }
    );
  }
</script>

<style>
  pre {
    outline: 1px solid #ccc;
    padding: 5px;
    margin: 5px;
  }
  .string {
    color: green;
  }
  .number {
    color: darkorange;
  }
  .boolean {
    color: blue;
  }
  .null {
    color: magenta;
  }
  .key {
    color: brown;
  }
</style>
