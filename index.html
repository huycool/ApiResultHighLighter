<html>

<head>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css" />
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsonata/jsonata.min.js"></script>
  <style>
    article {
      border: 1px solid #333;
    }
  </style>
</head>

<body>
  <main class="container">
    <div x-data="apiResultHiLighter()">
      <article>
        <label for="apiUrl">
          Api Url
          <input x-model="apiUrl" name="apiUrl" type="text" />
        </label>
        <label for="jsonataQuery">
          JSONata Query (<a href="https://jsonata.org/">link</a>)
          <input x-model="jsonataQuery" name="jsonataQuery" type="text" />
        </label>
        <label for="hightlightTerm">
          Highlight
          <input x-model="hightlightTerm" name="hightlightTerm" type="text" />
        </label>

        <button type="button" @click="executeApiHilight()" :aria-busy="isLoading">
          Search
        </button>
        <template x-if="data">
          <div id="tree-result" style="font-family: monospace; white-space: pre" x-html="searchResults"></div>
        </template>
        </ar>
    </div>
  </main>
</body>

</html>
<script>
  function apiResultHiLighter() {
    return {
      data: null,
      apiUrl: "https://api.warframestat.us/pc",
      jsonataQuery: "syndicateMissions.jobs",
      hightlightTerm: "",
      searchResults: "N/A",
      isLoading: false,
      executeApiHilight() {
        this.isLoading = true;
        this.searchResults = "Loading...";
        this.getJsonData().then((data) => {
          this.data = data;
          let result = data;

          if (this.jsonataQuery !== "")
            result = jsonata(this.jsonataQuery).evaluate(this.data);
          if (result != null) {
            this.searchResults = syntaxHighlight(
              JSON.stringify(result, null, "\t"),
              this.hightlightTerm === "" ? "zzzz" : this.hightlightTerm
            );
          } else {
            this.searchResults = JSON.stringify(data);
          }

          this.isLoading = false;
        });
      },
      async getJsonData() {
        try {
          let response = await fetch(this.apiUrl);
          return await response.json();
        } catch (err) {
          console.log(
            `Something went wrong: ${response.status} - ${response.statusText}`
          );
          alert(err); // TypeError: failed to fetch
          return { error: err };
        }
      },
    };
  }

  function syntaxHighlight(json, hilite) {
    json = json
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
    return json.replace(
      /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
      function (match) {
        var cls = "number";
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = "key";
          } else {
            cls = "string";
          }
        } else if (/true|false/.test(match)) {
          cls = "boolean";
        } else if (/null/.test(match)) {
          cls = "null";
        }
        let ret = '<span class="' + cls + '">' + match + "</span>";
        ret = ret.replaceAll(
          new RegExp(hilite, "gi"),
          "<mark>" + hilite + "</mark>"
        );
        return ret;
      }
    );
  }
</script>

<style>
  pre {
    outline: 1px solid #ccc;
    padding: 5px;
    margin: 5px;
  }

  .string {
    color: green;
  }

  .number {
    color: darkorange;
  }

  .boolean {
    color: blue;
  }

  .null {
    color: magenta;
  }

  .key {
    color: brown;
  }
</style>
